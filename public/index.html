<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhatsApp Linker</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.08);
      max-width: 480px;
      width: 100%;
      padding: 2.5rem;
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .logo {
      text-align: center;
      margin-bottom: 2rem;
    }

    .logo svg {
      width: 64px;
      height: 64px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .subtitle {
      text-align: center;
      color: #7f8c8d;
      font-size: 0.9rem;
      margin-bottom: 2rem;
    }

    .step {
      animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .hidden {
      display: none;
    }

    label {
      display: block;
      color: #555;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }

    input:focus {
      outline: none;
      border-color: #25D366;
      box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
    }

    .button-group {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    button {
      flex: 1;
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:active::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: #25D366;
      color: white;
    }

    .btn-primary:hover {
      background: #20bd5a;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
    }

    .btn-secondary {
      background: #f8f9fa;
      color: #495057;
      border: 2px solid #e1e8ed;
    }

    .btn-secondary:hover {
      background: #e9ecef;
      transform: translateY(-2px);
    }

    .status {
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      font-size: 0.9rem;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .error {
      background: #fee;
      color: #c33;
      border-left: 4px solid #c33;
    }

    .success {
      background: #efe;
      color: #2a7;
      border-left: 4px solid #2a7;
    }

    .info {
      background: #e3f2fd;
      color: #1976d2;
      border-left: 4px solid #1976d2;
    }

    .id-display {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      margin: 1.5rem 0;
      text-align: center;
    }

    .id-display strong {
      color: #25D366;
      font-size: 1.1rem;
      font-family: monospace;
    }

    .method-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .method-card {
      padding: 1.5rem;
      border: 2px solid #e1e8ed;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
    }

    .method-card:hover {
      border-color: #25D366;
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(37, 211, 102, 0.15);
    }

    .method-card svg {
      width: 48px;
      height: 48px;
      margin-bottom: 0.75rem;
    }

    .method-card h3 {
      font-size: 1rem;
      color: #2c3e50;
      margin-bottom: 0.25rem;
    }

    .method-card p {
      font-size: 0.8rem;
      color: #7f8c8d;
    }

    #qr-container {
      text-align: center;
      padding: 2rem 0;
    }

    #qr-container img {
      max-width: 280px;
      width: 100%;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      animation: qrAppear 0.5s ease-out;
    }

    @keyframes qrAppear {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .pairing-code-display {
      text-align: center;
      padding: 2rem;
    }

    .pairing-code-display .code {
      font-size: 3rem;
      font-weight: 700;
      letter-spacing: 0.5rem;
      color: #25D366;
      font-family: 'Courier New', monospace;
      margin: 1rem 0;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .pairing-instructions {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 8px;
      margin-top: 1rem;
      text-align: left;
    }

    .pairing-instructions h4 {
      color: #2c3e50;
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
    }

    .pairing-instructions ol {
      margin-left: 1.25rem;
      color: #555;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .pairing-instructions li {
      margin-bottom: 0.5rem;
    }

    .success-animation {
      text-align: center;
      padding: 2rem;
    }

    .success-animation svg {
      width: 80px;
      height: 80px;
      animation: checkmark 0.8s ease-out;
    }

    @keyframes checkmark {
      0% {
        transform: scale(0);
        opacity: 0;
      }
      50% {
        transform: scale(1.2);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .success-animation h2 {
      color: #25D366;
      margin: 1rem 0 0.5rem;
      font-size: 1.5rem;
    }

    .success-animation p {
      color: #7f8c8d;
      font-size: 0.95rem;
    }

    .success-animation .success-id {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1.5rem;
      font-family: monospace;
      color: #25D366;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: 0.5rem;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .phone-input-container {
      margin-bottom: 1.5rem;
    }

    .loading-text {
      text-align: center;
      color: #7f8c8d;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="#25D366" stroke-width="2">
        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
      </svg>
    </div>

    <h1>WhatsApp Linker</h1>
    <p class="subtitle">Connect your WhatsApp seamlessly</p>

    <!-- Step 1: ID Selection -->
    <div id="step1" class="step">
      <label>Choose Your Unique ID</label>
      <input id="idInput" placeholder="matdev-xxxxxxxx" />
      <div class="button-group">
        <button id="genId" class="btn-secondary">Generate ID</button>
        <button id="checkId" class="btn-primary">Continue</button>
      </div>
      <div id="idStatus"></div>
    </div>

    <!-- Step 2: Method Selection -->
    <div id="step2" class="step hidden">
      <div class="id-display">
        <p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.5rem;">Your ID</p>
        <strong id="chosenId"></strong>
      </div>
      <label>Select Pairing Method</label>
      <div class="method-selector">
        <div class="method-card" id="chooseQr">
          <svg viewBox="0 0 24 24" fill="none" stroke="#25D366" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"/>
            <rect x="14" y="3" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/>
            <path d="M14 14h1v1h-1v-1zm3 0h1v1h-1v-1zm-3 3h1v1h-1v-1zm3 0h1v1h-1v-1zm3-3h1v1h-1v-1zm0 3h1v1h-1v-1zm0 3h1v1h-1v-1z"/>
          </svg>
          <h3>QR Code</h3>
          <p>Scan with phone</p>
        </div>
        <div class="method-card" id="choosePair">
          <svg viewBox="0 0 24 24" fill="none" stroke="#25D366" stroke-width="2">
            <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <h3>8-Digit Code</h3>
          <p>Enter code manually</p>
        </div>
      </div>
    </div>

    <!-- Step 3: Phone Number (for pairing code) -->
    <div id="step2b" class="step hidden">
      <label>Enter Your WhatsApp Number</label>
      <div class="phone-input-container">
        <input id="phoneInput" type="tel" placeholder="+1234567890" />
        <p style="color: #7f8c8d; font-size: 0.85rem; margin-top: 0.5rem;">Include country code (e.g., +1 for US, +234 for Nigeria)</p>
      </div>
      <div class="button-group">
        <button id="backToMethod" class="btn-secondary">Back</button>
        <button id="submitPhone" class="btn-primary">Continue</button>
      </div>
      <div id="phoneStatus"></div>
    </div>

    <!-- Step 4: QR/Pairing Display -->
    <div id="step3" class="step hidden">
      <div id="pairingUi"></div>
      <div id="statusDisplay"></div>
    </div>

    <!-- Success Screen -->
    <div id="success" class="step hidden">
      <div class="success-animation">
        <svg viewBox="0 0 24 24" fill="none" stroke="#25D366" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <h2>Successfully Paired!</h2>
        <p>Your WhatsApp has been linked</p>
        <div class="success-id" id="successId"></div>
      </div>
    </div>
  </div>

<script>
let sessionId = null, uniqueId = null, method = null, pollTimer = null, phoneNumber = null;

const idInput = document.getElementById('idInput');
const phoneInput = document.getElementById('phoneInput');
const idStatus = document.getElementById('idStatus');
const phoneStatus = document.getElementById('phoneStatus');
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const step2b = document.getElementById('step2b');
const step3 = document.getElementById('step3');
const chosenId = document.getElementById('chosenId');
const pairingUi = document.getElementById('pairingUi');
const statusDisplay = document.getElementById('statusDisplay');
const successDiv = document.getElementById('success');
const successId = document.getElementById('successId');

function showStatus(element, message, type) {
  element.innerHTML = `<div class="status ${type}">${message}</div>`;
}

async function checkId(id) {
  idStatus.innerHTML = '';
  if (!id) {
    showStatus(idStatus, 'Please enter an ID', 'error');
    return false;
  }
  
  try {
    const res = await fetch(`/api/uniqueid/${id}/exists`);
    const data = await res.json();
    
    if (data.exists) {
      showStatus(idStatus, '‚ùå ID already exists. Please choose another.', 'error');
      return false;
    } else {
      showStatus(idStatus, '‚úÖ ID is available!', 'success');
      return true;
    }
  } catch (error) {
    showStatus(idStatus, '‚ö†Ô∏è Error checking ID', 'error');
    return false;
  }
}

document.getElementById('checkId').onclick = async () => {
  const id = idInput.value.trim();
  if (!id) {
    showStatus(idStatus, 'Please enter an ID', 'error');
    return;
  }
  
  if (await checkId(id)) {
    uniqueId = id;
    chosenId.textContent = uniqueId;
    step1.classList.add('hidden');
    step2.classList.remove('hidden');
  }
};

document.getElementById('genId').onclick = async () => {
  try {
    const res = await fetch('/api/uniqueid/generate');
    const data = await res.json();
    idInput.value = data.uniqueId;
    showStatus(idStatus, '‚ú® Generated! Click Continue to proceed.', 'success');
  } catch (error) {
    showStatus(idStatus, '‚ö†Ô∏è Error generating ID', 'error');
  }
};

document.getElementById('chooseQr').onclick = async () => {
  method = 'qr';
  await startSession();
};

document.getElementById('choosePair').onclick = () => {
  method = 'pairing';
  step2.classList.add('hidden');
  step2b.classList.remove('hidden');
};

document.getElementById('backToMethod').onclick = () => {
  step2b.classList.add('hidden');
  step2.classList.remove('hidden');
  phoneInput.value = '';
  phoneStatus.innerHTML = '';
};

document.getElementById('submitPhone').onclick = async () => {
  phoneNumber = phoneInput.value.trim();
  // Ensure phoneNumber is a string, not an object
  if (!phoneNumber) {
    showStatus(phoneStatus, 'Please enter your phone number', 'error');
    return;
  }
  if (!phoneNumber.match(/^\+\d{10,15}$/)) {
    showStatus(phoneStatus, 'Invalid format. Use +countrycode format (e.g., +1234567890)', 'error');
    return;
  }
  // Explicitly cast to string to avoid accidental object passing
  phoneNumber = String(phoneNumber);
  await startSession();
};

async function startSession() {
  const payload = { uniqueId, method };
  if (method === 'pairing' && phoneNumber) {
    // Ensure phoneNumber is a string
    payload.phoneNumber = String(phoneNumber);
  }
  
  try {
    const res = await fetch('/api/session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const data = await res.json();
    
    if (data.error) {
      const targetStatus = method === 'pairing' ? phoneStatus : statusDisplay;
      showStatus(targetStatus, `‚ùå ${data.error}`, 'error');
      return;
    }
    
    sessionId = data.sessionId;
    step2.classList.add('hidden');
    step2b.classList.add('hidden');
    step3.classList.remove('hidden');
    
    if (method === 'qr') {
      pairingUi.innerHTML = '<div class="loading-text"><div class="spinner"></div>Generating QR Code...</div>';
    } else {
      pairingUi.innerHTML = '<div class="loading-text"><div class="spinner"></div>Generating Pairing Code...</div>';
    }
    
    poll();
  } catch (error) {
    const targetStatus = method === 'pairing' ? phoneStatus : statusDisplay;
    showStatus(targetStatus, '‚ö†Ô∏è Connection error. Please try again.', 'error');
  }
}

async function poll() {
  if (!sessionId) return;
  
  try {
    if (method === 'qr') {
      const [qrRes, statusRes] = await Promise.all([
        fetch(`/api/session/${sessionId}/qr`),
        fetch(`/api/session/${sessionId}/status`)
      ]);
      
      let stop = false;
      
      if (statusRes.status === 200) {
        const st = await statusRes.json();
        
        console.log('[Frontend] QR Status:', st.status);
        
        // Don't stop on initializing/waiting states
        if (st.status === 'initializing' || st.status === 'waiting_qr') {
          showStatus(statusDisplay, '‚è≥ Preparing QR code...', 'info');
        } else if (st.status === 'reconnecting') {
          showStatus(statusDisplay, 'üîÑ Connecting...', 'info');
          // Do not show QR or reset UI while reconnecting
          stop = false;
        } else if (st.status === 'expired' || st.status === 'not_found') {
          showStatus(statusDisplay, '‚ö†Ô∏è Session expired. Please start again.', 'error');
          stop = true;
        } else if (st.status === 'disconnected') {
          showStatus(statusDisplay, '‚ö†Ô∏è Connection lost. Please try again.', 'error');
          stop = true;
        } else if (st.status === 'error' || st.status === 'qr_error') {
          showStatus(statusDisplay, '‚ö†Ô∏è Error generating QR code. Please try again.', 'error');
          stop = true;
        } else if (st.status === 'connected') {
          pairingUi.innerHTML = '';
          statusDisplay.innerHTML = '';
          step3.classList.add('hidden');
          successDiv.classList.remove('hidden');
          successId.textContent = uniqueId;
          return;
        } else if (st.status === 'qr') {
          showStatus(statusDisplay, 'üì± Scan the QR code with your phone', 'info');
        }
      }
      
      if (!stop && qrRes.status === 200) {
        const qrData = await qrRes.json();
        if (qrData.qr) {
          pairingUi.innerHTML = `<div id="qr-container"><img src="data:image/png;base64,${qrData.qr}" alt="QR Code" /></div>`;
        }
      }
      
      if (!stop) pollTimer = setTimeout(poll, 2000); // Faster polling
      
    } else if (method === 'pairing') {
      const [pairRes, statusRes] = await Promise.all([
        fetch(`/api/session/${sessionId}/pairing-code`),
        fetch(`/api/session/${sessionId}/status`)
      ]);
      
      let stop = false;
      
      if (statusRes.status === 200) {
        const st = await statusRes.json();
        
        console.log('[Frontend] Pairing Status:', st.status);
        
        // Don't stop on initializing/waiting states
        if (st.status === 'initializing' || st.status === 'waiting_pairing_code') {
          showStatus(statusDisplay, '‚è≥ Preparing pairing code...', 'info');
        } else if (st.status === 'expired' || st.status === 'not_found' || st.status === 'auth_failed') {
          showStatus(statusDisplay, '‚ö†Ô∏è Session expired or authentication failed. Please start again.', 'error');
          stop = true;
        } else if (st.status === 'disconnected') {
          showStatus(statusDisplay, '‚ö†Ô∏è Connection lost. Please try again.', 'error');
          stop = true;
        } else if (st.status === 'error' || st.status === 'pairing_error') {
          showStatus(statusDisplay, '‚ö†Ô∏è Error generating pairing code. Please check your phone number.', 'error');
          stop = true;
        } else if (st.status === 'connected') {
          pairingUi.innerHTML = '';
          statusDisplay.innerHTML = '';
          step3.classList.add('hidden');
          successDiv.classList.remove('hidden');
          successId.textContent = uniqueId;
          return;
        } else if (st.status === 'pairing_code') {
          showStatus(statusDisplay, '‚è∞ Enter the code in WhatsApp within 20 seconds', 'info');
        } else if (st.status === 'reconnecting') {
          showStatus(statusDisplay, 'üîÑ Connecting...', 'info');
        }
      }
      
      if (!stop && pairRes.status === 200) {
        const pairData = await pairRes.json();
        // Defensive: If pairingCode is an object, convert to string
        let codeDisplay = pairData.pairingCode;
        if (typeof codeDisplay === 'object') {
          codeDisplay = JSON.stringify(codeDisplay);
        }
        if (codeDisplay) {
          pairingUi.innerHTML = `
            <div class="pairing-code-display">
              <div class="code">${codeDisplay}</div>
              <div class="pairing-instructions">
                <h4>How to enter the code:</h4>
                <ol>
                  <li>Open WhatsApp on your phone</li>
                  <li>Go to <strong>Settings</strong> ‚Üí <strong>Linked Devices</strong></li>
                  <li>Tap <strong>Link a Device</strong></li>
                  <li>Select <strong>Link with phone number instead</strong></li>
                  <li>Enter the code above</li>
                </ol>
              </div>
            </div>
          `;
        }
      }
      
      if (!stop) pollTimer = setTimeout(poll, 2000); // Faster polling
    }
  } catch (error) {
    console.error('[Frontend] Poll error:', error);
    showStatus(statusDisplay, '‚ö†Ô∏è Connection error. Retrying...', 'error');
    pollTimer = setTimeout(poll, 5000);
  }
}
</script>
</body>
</html>